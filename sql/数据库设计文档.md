### 用户认证与授权服务

**核心功能**：用户身份管理、角色权限控制

**包含表**：`users`、`roles`、`user_roles`、`permissions`、`role_permissions`

**数据库：**`zhiyan_userauth_db`

#### 用户表（users）

```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '用户唯一标识',
    email VARCHAR(255) UNIQUE NOT NULL COMMENT '用户邮箱（登录账号）',
    password_hash VARCHAR(255) NOT NULL COMMENT '密码哈希值（加密存储）',
    name VARCHAR(100) NOT NULL COMMENT '用户姓名',
    avatar_url VARCHAR(500) COMMENT '用户头像URL',
    title VARCHAR(100) COMMENT '用户职称/职位',
    institution VARCHAR(200) COMMENT '用户所属机构',
    is_locked BOOLEAN DEFAULT FALSE COMMENT '是否锁定（禁止登录）',
    is_deleted BOOLEAN DEFAULT FALSE COMMENT '软删除标记',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) COMMENT '系统用户基本信息表';
```

#### 角色表（roles）

```sql
CREATE TABLE roles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '角色唯一标识',
    name VARCHAR(50) UNIQUE NOT NULL COMMENT '角色名称（如：ADMIN、USER）',
    description TEXT COMMENT '角色描述（如：系统管理员、普通用户）'
) COMMENT '系统角色定义表（用于权限分组）';
```

#### 用户 - 角色关联表（user_roles）

```sql
CREATE TABLE user_roles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '关联记录唯一标识',
    user_id BIGINT NOT NULL COMMENT '用户ID（关联users表）',
    role_id BIGINT NOT NULL COMMENT '角色ID（关联roles表）',
    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '角色分配时间',
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,  -- 角色删除时级联删除关联记录
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,  -- 权限删除时级联删除关联记录
    UNIQUE KEY (user_id, role_id) COMMENT '确保用户不能重复关联同一角色'
) COMMENT '用户与角色的多对多关联表';
```

#### 权限表（permissions）

```sql
CREATE TABLE permissions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '权限唯一标识',
    name VARCHAR(100) UNIQUE NOT NULL COMMENT '权限名称（如：project:create、task:edit）',
    description TEXT COMMENT '权限描述（如：创建项目权限、编辑任务权限）'
) COMMENT '系统权限定义表（细粒度操作权限）';
```

#### 角色 - 权限关联表（role_permissions）

```sql
CREATE TABLE role_permissions (
    role_id BIGINT NOT NULL COMMENT '角色ID（关联roles表，角色删除时级联删除此记录）',
    permission_id BIGINT NOT NULL COMMENT '权限ID（关联permissions表，权限删除时级联删除此记录）',
    granted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '权限授予时间',
    PRIMARY KEY (role_id, permission_id) COMMENT '复合主键（角色+权限唯一）',
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    FOREIGN KEY (permission_id) REFERENCES permissions(id) ON DELETE CASCADE
) COMMENT '角色与权限的多对多关联表（角色继承权限，关联关系随角色/权限删除而自动删除）';
```





### 项目和任务管理服务（）

**核心功能**：项目创建、成员管理、加入申请处理、任务创建、分配、状态跟踪

**包含表**：`projects`、`project_members`、`project_join_requests`、`tasks`

**数据库：**`zhiyan_projectteam_db`

#### 项目表（projects）

```sql
CREATE TABLE projects (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '项目唯一标识',
    name VARCHAR(200) NOT NULL COMMENT '项目名称',
    description TEXT COMMENT '项目描述',
    status ENUM('PLANNING', 'ONGOING', 'COMPLETED', 'ARCHIVED') DEFAULT 'PLANNING' COMMENT '项目状态（规划中/进行中/已完成/已归档）',
    visibility ENUM('PUBLIC', 'PRIVATE') DEFAULT 'PRIVATE' COMMENT '项目可见性（公开/私有）',
    start_date DATE COMMENT '项目开始日期',
    end_date DATE COMMENT '项目结束日期',
    created_by BIGINT NOT NULL COMMENT '创建人ID（逻辑关联users表）',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) COMMENT '项目基本信息表';
```

#### 项目成员表（project_members）

```sql
CREATE TABLE project_members (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '成员记录唯一标识',
    project_id BIGINT NOT NULL COMMENT '项目ID（逻辑关联projects表）',
    user_id BIGINT NOT NULL COMMENT '用户ID（逻辑关联users表）',
    project_role ENUM('LEADER', 'MAINTAINER', 'MEMBER') NOT NULL COMMENT '项目内角色（负责人/维护者/普通成员）',
    permissions_override JSON COMMENT '权限覆盖（JSON格式，用于临时修改成员在项目内的权限）',
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '加入项目时间',
#     FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE COMMENT '项目删除时级联删除成员记录',
#     FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE COMMENT '用户删除时级联删除成员记录',
#     FOREIGN KEY (invited_by) REFERENCES users(id) COMMENT '关联邀请人信息',
    UNIQUE KEY (project_id, user_id) COMMENT '确保用户不能重复加入同一项目',
    -- 索引：优化项目成员查询
    INDEX idx_project (project_id),
    INDEX idx_user (user_id)
) COMMENT '项目成员关系表（记录用户在项目中的角色和权限）';
```

#### 项目加入申请表（project_join_requests）

```sql
CREATE TABLE project_join_requests (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '申请记录唯一标识',
    project_id BIGINT NOT NULL COMMENT '项目ID（逻辑关联projects表）',
    user_id BIGINT NOT NULL COMMENT '申请人ID（逻辑关联users表）',
    status ENUM('PENDING', 'APPROVED', 'REJECTED') DEFAULT 'PENDING' COMMENT '申请状态（待处理/已批准/已拒绝）',
    message TEXT COMMENT '申请说明（申请人填写的加入理由）',
    responded_at TIMESTAMP NULL COMMENT '处理时间',
    responded_by BIGINT NULL COMMENT '处理人ID（逻辑关联users表），处理人可以是项目负责人或管理员',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '申请时间',
#     FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE COMMENT '项目删除时级联删除申请记录',
#     FOREIGN KEY (user_id) REFERENCES users(id) COMMENT '关联申请人信息',
#     FOREIGN KEY (responded_by) REFERENCES users(id) COMMENT '关联处理人信息',
    UNIQUE KEY (project_id, user_id, status) COMMENT '同一用户对同一项目的同一状态申请唯一',
    -- 索引：优化申请查询
    INDEX idx_project_status (project_id, status),
    INDEX idx_user (user_id)
) COMMENT '用户加入项目的申请表';
```

#### 任务表（tasks）

```sql
CREATE TABLE tasks (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '任务唯一标识',
    project_id BIGINT NOT NULL COMMENT '所属项目ID（本服务内关联projects表）',
    title VARCHAR(200) NOT NULL COMMENT '任务标题',
    description TEXT COMMENT '任务描述',
    status ENUM('TODO', 'IN_PROGRESS', 'BLOCKED', 'DONE') DEFAULT 'TODO' COMMENT '任务状态（待办/进行中/阻塞/已完成）',
    priority ENUM('HIGH', 'MEDIUM', 'LOW') DEFAULT 'MEDIUM' COMMENT '任务优先级（高/中/低）',
    -- 移除与用户服务users表的外键约束，仅保留逻辑关联的用户ID
    assignee_id JSON NOT NULL COMMENT '负责人ID（逻辑关联用户服务的用户ID，可为空表示未分配）JSON类型存储多个负责人ID',
    due_date DATE COMMENT '任务截止日期',
    -- 和创建人ID仅作为逻辑关联，移除外键约束
    created_by BIGINT NOT NULL COMMENT '创建人ID（逻辑关联用户服务的用户ID）',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    -- 保留服务内部的外键约束（项目服务内的表关联）
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,  -- '项目删除时级联删除任务（服务内部约束）'
    -- 新增索引
    INDEX idx_assignee_id (assignee_id(255)) COMMENT '优化JSON字段查询（前缀索引）',
    INDEX idx_created_by (created_by) COMMENT '优化按创建人查询'
) COMMENT '项目任务表（与用户服务松耦合，通过ID逻辑关联用户）';
```



### 成果管理服务（Artifact Service）

**核心功能**：成果（论文、专利等）管理及附件存储

**包含表**：`artifacts`、`artifact_attachments`

**数据库：**`zhiyan_artifact_db`

#### 成果表（artifacts）

```sql
CREATE TABLE artifacts (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '成果唯一标识',
    project_id BIGINT NOT NULL COMMENT '所属项目ID（逻辑关联项目服务的projects表）',
    type ENUM('PAPER', 'PATENT', 'CODE', 'DATASET', 'MODEL', 'REPORT') NOT NULL COMMENT '成果类型',
    title VARCHAR(500) NOT NULL COMMENT '成果标题',
    description TEXT COMMENT '成果描述',
    doi VARCHAR(255) COMMENT 'DOI编号',
    journal VARCHAR(255) COMMENT '发表期刊',
    patent_number VARCHAR(100) COMMENT '专利号',
    dataset_version VARCHAR(50) COMMENT '数据集版本',
    custom_fields JSON COMMENT '自定义字段（JSON格式）',
    status ENUM('DRAFT', 'UNDER_REVIEW', 'PUBLISHED') DEFAULT 'DRAFT' COMMENT '成果状态',
    created_by BIGINT NOT NULL COMMENT '创建人ID（逻辑关联用户服务的users表）',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    -- 移除跨数据库外键约束，保留索引优化查询
    INDEX idx_project_id (project_id) COMMENT '关联项目ID索引',
    INDEX idx_created_by (created_by) COMMENT '关联创建人ID索引',
    INDEX idx_doi (doi) COMMENT 'DOI索引',
    INDEX idx_patent_number (patent_number) COMMENT '专利号索引'
) COMMENT '项目成果表（与项目服务、用户服务松耦合，通过ID逻辑关联）';
```



#### 成果附件表（artifact_attachments）

```sql
CREATE TABLE artifact_attachments (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '附件唯一标识',
    artifact_id BIGINT NOT NULL COMMENT '所属成果ID（本服务内关联artifacts表）',
    file_name VARCHAR(255) NOT NULL COMMENT '附件文件名',
    file_key VARCHAR(500) NOT NULL COMMENT '文件存储键',
    file_size BIGINT COMMENT '文件大小（字节）',
    mime_type VARCHAR(100) COMMENT '文件MIME类型',
    version INTEGER DEFAULT 1 COMMENT '附件版本',
    uploaded_by BIGINT NOT NULL COMMENT '上传人ID（逻辑关联用户服务的users表）',
    uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '上传时间',
    -- 保留同一数据库内的外键约束，移除跨库约束
    FOREIGN KEY (artifact_id) REFERENCES artifacts(id) ON DELETE CASCADE COMMENT '成果删除时级联删除附件（服务内约束）',
    INDEX idx_uploaded_by (uploaded_by) COMMENT '关联上传人ID索引'
) COMMENT '成果附件表（与用户服务松耦合，通过ID逻辑关联）';
```



### 文档服务（Wiki Service）

**核心功能**：项目 Wiki 文档的创建、编辑、版本管理

**包含表**：`wiki_pages`

**数据库：**`zhiyan_wiki_db`

#### Wiki 文档表（wiki_pages）

```sql
CREATE TABLE wiki_pages (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '文档唯一标识',
    project_id BIGINT NOT NULL COMMENT '所属项目ID（逻辑关联项目服务的projects表）',
    title VARCHAR(200) NOT NULL COMMENT '文档标题',
    slug VARCHAR(200) NOT NULL COMMENT '文档路径标识',
    content LONGTEXT COMMENT '文档内容',
    parent_id BIGINT NULL COMMENT '父文档ID（本服务内关联wiki_pages表）',
    order_index INT DEFAULT 0 COMMENT '排序索引',
    version INT DEFAULT 1 COMMENT '文档版本',
    created_by BIGINT NOT NULL COMMENT '创建人ID（逻辑关联用户服务的users表）',
    updated_by BIGINT NOT NULL COMMENT '最后更新人ID（逻辑关联用户服务的users表）',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    -- 保留服务内的外键约束，移除跨库约束
    FOREIGN KEY (parent_id) REFERENCES wiki_pages(id) ON DELETE SET NULL COMMENT '父文档删除时设为NULL（服务内约束）',
    UNIQUE KEY (project_id, slug) COMMENT '同一项目内文档路径标识唯一',
    INDEX idx_project_id (project_id) COMMENT '关联项目ID索引',
    INDEX idx_created_by (created_by) COMMENT '关联创建人ID索引',
    INDEX idx_updated_by (updated_by) COMMENT '关联更新人ID索引'
) COMMENT '项目Wiki文档表（与项目服务、用户服务松耦合，通过ID逻辑关联）';
```





### 系统活动日志服务（Activity Log Service）

**核心功能**：系统操作日志的记录与查询

**包含表**：`activity_logs`

**数据库：**`zhiyan_syslog_db`

#### 活动日志表（activity_logs）

```sql
CREATE TABLE activity_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '日志唯一标识',
    project_id BIGINT NULL COMMENT '所属项目ID（逻辑关联项目服务的projects表，空表示系统级操作）',
    user_id BIGINT NOT NULL COMMENT '操作人ID（逻辑关联用户服务的users表）',
    entity_type ENUM('TASK', 'ARTIFACT', 'WIKI', 'PROJECT', 'USER') NOT NULL COMMENT '操作实体类型',
    entity_id BIGINT NOT NULL COMMENT '操作实体ID',
    action VARCHAR(100) NOT NULL COMMENT '操作类型',
    description TEXT COMMENT '操作描述',
    details JSON COMMENT '操作详情（JSON格式）',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
    -- 移除所有跨数据库外键约束，保留索引
    INDEX idx_entity (entity_type, entity_id) COMMENT '实体类型+ID联合索引',
    INDEX idx_project_time (project_id, created_at) COMMENT '项目ID+时间联合索引',
    INDEX idx_user_id (user_id) COMMENT '操作人ID索引'
) COMMENT '系统活动日志表（与所有外部服务松耦合，通过ID逻辑关联）';
```

